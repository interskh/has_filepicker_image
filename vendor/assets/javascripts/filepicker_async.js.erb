(function(a){if(window.filepicker){return}var b=a.createElement("script");b.type="text/javascript";b.async=!0;b.src=("https:"===a.location.protocol?"https:":"http:")+"//api.filepicker.io/v1/filepicker.js";var c=a.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c);var d={};d._queue=[];var e="pick,pickMultiple,pickAndStore,read,write,writeUrl,export,convert,store,storeUrl,remove,stat,setKey,constructWidget,makeDropPane".split(",");var f=function(a,b){return function(){b.push([a,arguments])}};for(var g=0;g<e.length;g++){d[e[g]]=f(e[g],d._queue)}window.filepicker=d})(document);

filepicker.setKey('<%= ::Rails.application.config.has_filepicker_image.api_key %>');

filepicker.previewPickedImage = function($elem, url) {
  var $container = $elem.find('.filepicker-image:first');
  var img = $("<img src='" + url + '/convert?w=50&h=50' + '\'/>');
  $container.html(img);
  return true;
};

filepicker.addDeleteButton = function($button, $elem) {
  if ($button.data('delete_button') !== false)
    $elem.append("<a href='#' class='btn' data-action='removeImage'><%= Rails.application.config.has_filepicker_image.defaults[:delete_button_html] %></a>");
};

filepicker.pickImage = function($button) {
  var data = $button.data();
  var $elem = $button.parent();
  filepicker.pickAndStore(
    data,
    data,
    function(fpfiles) {
      var url = fpfiles[0].url;
      $elem.find('input[type=hidden]').val(url);
      filepicker.previewPickedImage($elem, url);
      filepicker.addDeleteButton($button, $elem);
      $button.hide();
    },
    function(fpfiles) {
      alert('Error uploading file');
    }
  );
};

$(document).on('click', '.has_many.attachments .button', function(event) {
  $input_element = $(this).closest('.has_many.attachments').find("[type='filepicker']:last");
  filepicker.pickImange( $element );
});

$(document).on('nested:fieldAdded', function(event) {
  var field = event.field;
  var $element = field.find("[data-action=pickImage]");
  if ($element.size() > 0) {
    filepicker.pickImage( $element );
  }
});

$(document).on('click', 'a[data-action=pickImage]', function(event) {
  event.preventDefault();
  filepicker.pickImage( $(this) );
});

$(document).on('click', 'a[data-action=removeImage]', function(event) {
  event.preventDefault();

  var $this = $(this);
  var $parent = $this.parent();
  $parent.find('input[type=hidden]').val('');
  $parent.find('.filepicker-image').html('');
  $parent.find('[data-action=removeImage]').hide();
  $parent.find('[data-action=pickImage]').show();
});

